<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOL Finder - Find Active Players</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23c9aa71'/%3E%3Cstop offset='100%25' stop-color='%23a08050'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='26' cy='26' r='18' fill='none' stroke='url(%23g)' stroke-width='6'/%3E%3Cline x1='39' y1='39' x2='56' y2='56' stroke='url(%23g)' stroke-width='8' stroke-linecap='round'/%3E%3Ccircle cx='26' cy='26' r='8' fill='%232ecc71' opacity='0.8'/%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
        }

        h1 {
            font-size: 2.2rem;
            background: linear-gradient(90deg, #c9aa71, #f0e6d3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #8892b0;
            font-size: 1rem;
        }

        .info-banner {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 8px;
            padding: 10px 16px;
            margin-bottom: 16px;
            font-size: 0.85rem;
            color: #2ecc71;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: 1.1rem;
            color: #c9aa71;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .form-section-title {
            font-size: 0.8rem;
            color: #c9aa71;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        label {
            font-size: 0.75rem;
            color: #8892b0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #c9aa71;
        }

        select option {
            background: #1a1a2e;
        }

        .lp-display {
            font-size: 0.8rem;
            color: #c9aa71;
            margin-top: 2px;
        }

        .input-hint {
            font-size: 0.7rem;
            color: #666;
            margin-top: 2px;
        }

        .range-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .range-row .form-group {
            flex: 1;
        }

        .range-sep {
            padding-bottom: 12px;
            color: #8892b0;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #c9aa71, #a08050);
            color: #1a1a2e;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(201, 170, 113, 0.3);
        }

        .btn-stop {
            background: #e74c3c;
            color: #fff;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            align-items: center;
        }

        .rate-limit-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #e74c3c;
            animation: rateLimitPulse 1s infinite;
        }

        .rate-limit-indicator.show {
            display: flex;
        }

        @keyframes rateLimitPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .rate-limit-indicator .countdown {
            font-weight: 700;
            font-family: 'Consolas', monospace;
        }

        /* Results Panel */
        .results-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 12px;
        }

        .results-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #c9aa71;
            font-size: 1.1rem;
        }

        .results-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 8px 12px 8px 32px;
            width: 200px;
            font-size: 0.85rem;
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
        }

        .btn-clear {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-clear:hover {
            background: rgba(231, 76, 60, 0.4);
        }

        .btn-export, .btn-import {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.5);
            color: #2ecc71;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-export:hover, .btn-import:hover {
            background: rgba(46, 204, 113, 0.4);
        }

        .btn-import {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.5);
            color: #3498db;
        }

        .btn-import:hover {
            background: rgba(52, 152, 219, 0.4);
        }

        .btn-delete-selected {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-delete-selected:hover {
            background: rgba(231, 76, 60, 0.4);
        }

        .checkbox-col {
            width: 40px;
            text-align: center;
        }

        .checkbox-col input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #c9aa71;
        }

        .player-count {
            background: rgba(201, 170, 113, 0.2);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            color: #c9aa71;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-searching {
            background: #f39c12;
            animation: pulse 1s infinite;
        }

        .status-complete {
            background: #2ecc71;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Data Table */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            position: sticky;
            top: 0;
            background: #1a1a2e;
            padding: 12px 16px;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #8892b0;
            cursor: pointer;
            user-select: none;
            border-bottom: 2px solid rgba(201, 170, 113, 0.3);
            white-space: nowrap;
        }

        .data-table th:hover {
            color: #c9aa71;
        }

        .data-table th.sorted-asc::after {
            content: " ‚ñ≤";
            color: #c9aa71;
        }

        .data-table th.sorted-desc::after {
            content: " ‚ñº";
            color: #c9aa71;
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }

        .data-table tr {
            transition: background 0.2s ease;
        }

        .data-table tr:hover {
            background: rgba(201, 170, 113, 0.1);
        }

        .data-table tr.new-row {
            animation: highlightNew 1s ease;
        }

        @keyframes highlightNew {
            0% { background: rgba(46, 204, 113, 0.3); }
            100% { background: transparent; }
        }

        .player-name {
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-actions {
            display: flex;
            gap: 4px;
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.2s;
        }

        tr:hover .player-actions {
            opacity: 1;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 3px 6px;
            border-radius: 4px;
            color: #8892b0;
            cursor: pointer;
            font-size: 0.65rem;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .action-btn.opgg {
            background: rgba(32, 45, 55, 0.8);
            color: #5383e8;
        }

        .action-btn.opgg:hover {
            background: #5383e8;
            color: #fff;
        }

        .action-btn.log {
            background: rgba(37, 99, 235, 0.2);
            color: #60a5fa;
        }

        .action-btn.log:hover {
            background: #2563eb;
            color: #fff;
        }

        .action-btn.delete {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            font-weight: bold;
        }

        .action-btn.delete:hover {
            background: #e74c3c;
            color: #fff;
        }

        .rank-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .rank-iron { background: #5c5c5c; }
        .rank-bronze { background: #8b4513; }
        .rank-silver { background: #708090; }
        .rank-gold { background: #c9aa71; color: #1a1a2e; }
        .rank-platinum { background: #4a9b7f; }
        .rank-emerald { background: #2ecc71; color: #1a1a2e; }
        .rank-diamond { background: #9b59b6; }

        .queue-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            background: rgba(255, 255, 255, 0.1);
        }

        .active-badge {
            color: #2ecc71;
            font-weight: 600;
        }

        .cache-badge {
            font-size: 0.7rem;
            margin-left: 4px;
            opacity: 0.7;
        }

        .updated-time {
            font-size: 0.7rem;
            color: #8892b0;
            margin-top: 2px;
        }

        .game-mode-badge {
            font-size: 0.75rem;
            color: #c9aa71;
        }

        .hot-streak {
            color: #e74c3c;
        }

        .winrate-good { color: #2ecc71; }
        .winrate-ok { color: #f39c12; }
        .winrate-bad { color: #e74c3c; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8892b0;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        /* Log Panel */
        .log-toggle {
            background: none;
            border: none;
            color: #8892b0;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .log-toggle:hover {
            color: #c9aa71;
        }

        .log-panel {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            padding: 12px;
            max-height: 150px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.8rem;
            color: #8892b0;
            display: none;
        }

        .log-panel.show {
            display: block;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .mode-toggle {
            display: flex;
            gap: 4px;
        }

        .mode-btn {
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            color: #8892b0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: rgba(201, 170, 113, 0.2);
            border-color: #c9aa71;
            color: #c9aa71;
        }

        .lp-ref {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 4px;
            margin-top: 8px;
            font-size: 0.7rem;
            color: #666;
        }

        .tier-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .collapsible {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible.collapsed {
            max-height: 0;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }

            .results-controls {
                width: 100%;
                justify-content: space-between;
            }

            .search-box input {
                width: 150px;
            }

            .data-table {
                font-size: 0.8rem;
            }

            .data-table th, .data-table td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>LOL Finder</h1>
            <p class="subtitle">Find active ranked players to duo with</p>
        </header>

        <div class="info-banner">
            ‚úì Activity checked across ALL game modes (Ranked, Draft, ARAM, Swiftplay, Co-op vs AI, etc.)
        </div>

        <div class="panel">
            <div class="panel-title">‚öô Search Settings</div>

            <div class="form-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Region</label>
                        <select id="region">
                            <option value="na1" data-routing="americas">NA</option>
                            <option value="euw1" data-routing="europe">EUW</option>
                            <option value="eun1" data-routing="europe">EUNE</option>
                            <option value="kr" data-routing="asia">KR</option>
                            <option value="jp1" data-routing="asia">JP</option>
                            <option value="br1" data-routing="americas">BR</option>
                            <option value="la1" data-routing="americas">LAN</option>
                            <option value="la2" data-routing="americas">LAS</option>
                            <option value="oc1" data-routing="sea">OCE</option>
                            <option value="tr1" data-routing="europe">TR</option>
                            <option value="ru" data-routing="europe">RU</option>
                            <option value="ph2" data-routing="sea">PH</option>
                            <option value="sg2" data-routing="sea">SG</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Queue</label>
                        <select id="queue">
                            <option value="">Both</option>
                            <option value="solo">Solo/Duo</option>
                            <option value="flex">Flex</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Active Within</label>
                        <input type="number" id="activeMinutes" value="30" min="1" max="1440">
                        <div class="input-hint">minutes</div>
                    </div>
                    <div class="form-group">
                        <label>Find Players</label>
                        <input type="number" id="maxPlayers" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Min WR%</label>
                        <input type="number" id="minWinRate" value="0" min="0" max="100" step="5">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">
                    Rank Filter
                    <div class="mode-toggle" style="display: inline-flex; margin-left: 12px;">
                        <button class="mode-btn active" id="modeLp" onclick="setRankMode('lp')">LP Range</button>
                        <button class="mode-btn" id="modeTier" onclick="setRankMode('tier')">Tier</button>
                    </div>
                </div>

                <div id="lpRangeMode">
                    <div class="range-row">
                        <div class="form-group">
                            <label>Min LP</label>
                            <input type="number" id="lpMin" value="800" min="0" max="2800" step="100">
                            <div class="lp-display" id="lpMinDisplay">Silver IV</div>
                        </div>
                        <div class="range-sep">‚Üí</div>
                        <div class="form-group">
                            <label>Max LP</label>
                            <input type="number" id="lpMax" value="1200" min="0" max="2800" step="100">
                            <div class="lp-display" id="lpMaxDisplay">Gold IV</div>
                        </div>
                    </div>
                    <div class="lp-ref">
                        <span>Iron: 0-399</span>
                        <span>Bronze: 400-799</span>
                        <span>Silver: 800-1199</span>
                        <span>Gold: 1200-1599</span>
                        <span>Plat: 1600-1999</span>
                        <span>Emerald: 2000-2399</span>
                        <span>Diamond: 2400-2799</span>
                    </div>
                </div>

                <div id="tierDivisionMode" style="display: none;">
                    <div class="tier-grid">
                        <div class="form-group">
                            <label>Tier</label>
                            <select id="tier">
                                <option value="IRON">Iron</option>
                                <option value="BRONZE">Bronze</option>
                                <option value="SILVER">Silver</option>
                                <option value="GOLD" selected>Gold</option>
                                <option value="PLATINUM">Platinum</option>
                                <option value="EMERALD">Emerald</option>
                                <option value="DIAMOND">Diamond</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Division</label>
                            <select id="division">
                                <option value="IV">IV</option>
                                <option value="III">III</option>
                                <option value="II" selected>II</option>
                                <option value="I">I</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="searchBtn" onclick="startSearch()">
                    <span id="searchBtnText">Start Search</span>
                </button>
                <div class="rate-limit-indicator" id="rateLimitIndicator">
                    <span>‚è≥ Rate Limited</span>
                    <span class="countdown" id="rateLimitCountdown">2:00</span>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="results-panel">
            <div class="results-header">
                <div class="results-title">
                    <span id="statusIndicator" class="status-indicator" style="display: none;"></span>
                    <span>üìã Results</span>
                    <span class="player-count" id="playerCount">0 found</span>
                </div>
                <div class="results-controls">
                    <div class="search-box">
                        <input type="text" id="searchFilter" placeholder="Filter players..." oninput="filterPlayers()">
                    </div>
                    <button class="btn-delete-selected" id="deleteSelectedBtn" onclick="deleteSelected()" style="display:none">Delete Selected (<span id="selectedCount">0</span>)</button>
                    <button class="btn-export" onclick="exportPlayers()" title="Export to file">Export</button>
                    <button class="btn-import" onclick="document.getElementById('importFile').click()" title="Import from file">Import</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importPlayers(event)">
                    <button class="btn-clear" onclick="clearSavedPlayers()" title="Clear all results">Clear</button>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th class="checkbox-col"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()" title="Select all"></th>
                            <th data-sort="name" onclick="sortTable('name')">Player</th>
                            <th data-sort="rank" onclick="sortTable('rank')">Rank</th>
                            <th data-sort="queue" onclick="sortTable('queue')">Queue</th>
                            <th data-sort="lastActiveMinutes" onclick="sortTable('lastActiveMinutes')">Active</th>
                            <th data-sort="lastGameMode" onclick="sortTable('lastGameMode')">Last Game</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">üéÆ</div>
                    <p>Click Start Search to find active players</p>
                </div>
            </div>
        </div>

        <!-- Log Section -->
        <div class="panel" style="padding: 12px 20px;">
            <button class="log-toggle" onclick="toggleLog()">
                <span id="logToggleIcon">‚ñ∂</span> Search Log
            </button>
            <div class="log-panel" id="logPanel">
                <div class="log-entry">Ready...</div>
            </div>
        </div>
    </div>

    <script>
        let isSearching = false;
        let eventSource = null;
        let players = [];
        let rankMode = 'lp';
        let currentSort = { column: 'lastActiveMinutes', direction: 'asc' };

        const STORAGE_KEY = 'lol_finder_players';

        // Save players to localStorage
        function savePlayers() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    players: players,
                    savedAt: Date.now()
                }));
                console.log(`[UI] Saved ${players.length} players to localStorage`);
            } catch (e) {
                console.error('[UI] Error saving to localStorage:', e);
            }
        }

        // Load players from localStorage
        function loadPlayers() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                console.log('[UI] Loading from localStorage, found:', saved ? 'yes' : 'no');
                if (saved) {
                    const data = JSON.parse(saved);
                    players = data.players || [];
                    // Adjust active times based on how long ago they were saved
                    const savedAge = Math.floor((Date.now() - data.savedAt) / 60000);
                    console.log(`[UI] Saved ${savedAge} minutes ago`);
                    players = players.map(p => ({
                        ...p,
                        lastActiveMinutes: p.lastActiveMinutes + savedAge
                    }));
                    renderTable();
                    updateUI();
                    console.log(`[UI] Loaded ${players.length} players from storage`);
                }
            } catch (e) {
                console.error('[UI] Error loading from localStorage:', e);
            }
        }

        // Clear saved players
        function clearSavedPlayers() {
            players = [];
            localStorage.removeItem(STORAGE_KEY);
            renderTable();
            updateUI();
        }

        // Selection management
        let selectedPuuids = new Set();
        let lastClickedIndex = null;

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.player-checkbox');

            if (selectAllCheckbox.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    selectedPuuids.add(cb.dataset.puuid);
                });
            } else {
                checkboxes.forEach(cb => {
                    cb.checked = false;
                });
                selectedPuuids.clear();
            }
            updateDeleteButton();
        }

        function handleCheckboxClick(event, index) {
            const checkboxes = Array.from(document.querySelectorAll('.player-checkbox'));
            const clickedCheckbox = checkboxes[index];

            // Shift+click for range selection
            if (event.shiftKey && lastClickedIndex !== null && lastClickedIndex !== index) {
                const start = Math.min(lastClickedIndex, index);
                const end = Math.max(lastClickedIndex, index);
                const shouldCheck = clickedCheckbox.checked;

                for (let i = start; i <= end; i++) {
                    checkboxes[i].checked = shouldCheck;
                }
            }

            lastClickedIndex = index;
            updateSelection();
        }

        function updateSelection() {
            selectedPuuids.clear();
            const checkboxes = document.querySelectorAll('.player-checkbox:checked');
            checkboxes.forEach(cb => {
                selectedPuuids.add(cb.dataset.puuid);
            });

            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.player-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            if (allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkboxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }

            updateDeleteButton();
        }

        function updateDeleteButton() {
            const btn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');
            countSpan.textContent = selectedPuuids.size;
            btn.style.display = selectedPuuids.size > 0 ? 'inline-block' : 'none';
        }

        function deleteSelected() {
            if (selectedPuuids.size === 0) return;

            const count = selectedPuuids.size;
            players = players.filter(p => !selectedPuuids.has(p.puuid));
            selectedPuuids.clear();

            savePlayers();
            renderTable();
            updateUI();
            updateDeleteButton();

            // Reset select all checkbox
            document.getElementById('selectAll').checked = false;
            document.getElementById('selectAll').indeterminate = false;

            console.log(`[UI] Deleted ${count} players`);
        }

        // Export players to JSON file
        function exportPlayers() {
            if (players.length === 0) {
                alert('No players to export');
                return;
            }
            const data = {
                exportedAt: Date.now(),
                playerCount: players.length,
                players: players
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lol-finder-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log(`[UI] Exported ${players.length} players to file`);
        }

        // Import players from JSON file
        function importPlayers(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    let importedPlayers = [];

                    // Handle both formats: {players: [...]} or just [...]
                    if (Array.isArray(data)) {
                        importedPlayers = data;
                    } else if (data.players && Array.isArray(data.players)) {
                        importedPlayers = data.players;
                    } else {
                        throw new Error('Invalid file format');
                    }

                    // Merge with existing players (match by puuid OR name)
                    let newCount = 0;
                    let updatedCount = 0;

                    for (const player of importedPlayers) {
                        if (!player.name && !player.puuid) continue;

                        // Find existing player by puuid first, then by name
                        let existingIndex = -1;
                        if (player.puuid) {
                            existingIndex = players.findIndex(p => p.puuid === player.puuid);
                        }
                        if (existingIndex < 0 && player.name) {
                            existingIndex = players.findIndex(p => p.name === player.name);
                        }

                        if (existingIndex >= 0) {
                            // Merge: keep existing fields, overwrite with imported data
                            players[existingIndex] = { ...players[existingIndex], ...player };
                            updatedCount++;
                        } else {
                            players.push(player);
                            newCount++;
                        }
                    }

                    savePlayers();
                    renderTable();
                    updateUI();
                    alert(`Imported ${newCount} new players, updated ${updatedCount} existing`);
                    console.log(`[UI] Imported ${newCount} new, ${updatedCount} updated from file`);
                } catch (err) {
                    alert('Error importing file: ' + err.message);
                    console.error('[UI] Import error:', err);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        // LP display updates
        document.getElementById('lpMin').addEventListener('input', updateLPDisplay);
        document.getElementById('lpMax').addEventListener('input', updateLPDisplay);

        function setRankMode(mode) {
            rankMode = mode;
            document.getElementById('modeLp').classList.toggle('active', mode === 'lp');
            document.getElementById('modeTier').classList.toggle('active', mode === 'tier');
            document.getElementById('lpRangeMode').style.display = mode === 'lp' ? 'block' : 'none';
            document.getElementById('tierDivisionMode').style.display = mode === 'tier' ? 'block' : 'none';
        }

        async function updateLPDisplay() {
            const lpMin = document.getElementById('lpMin').value;
            const lpMax = document.getElementById('lpMax').value;
            try {
                const [minInfo, maxInfo] = await Promise.all([
                    fetch(`/api/lpinfo?lp=${lpMin}`).then(r => r.json()),
                    fetch(`/api/lpinfo?lp=${lpMax}`).then(r => r.json())
                ]);
                document.getElementById('lpMinDisplay').textContent = `${minInfo.tier} ${minInfo.division}`;
                document.getElementById('lpMaxDisplay').textContent = `${maxInfo.tier} ${maxInfo.division}`;
            } catch (e) {}
        }
        updateLPDisplay();

        async function startSearch() {
            if (isSearching) {
                stopSearch();
                return;
            }

            const regionSelect = document.getElementById('region');
            const region = regionSelect.value;
            const regionV5 = regionSelect.options[regionSelect.selectedIndex].dataset.routing;

            await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ region, regionV5 })
            });

            isSearching = true;
            updateUI();

            const params = new URLSearchParams({
                active: document.getElementById('activeMinutes').value,
                max: document.getElementById('maxPlayers').value,
                queue: document.getElementById('queue').value,
                winrate: document.getElementById('minWinRate').value / 100
            });

            if (rankMode === 'lp') {
                params.set('lp', `${document.getElementById('lpMin').value}-${document.getElementById('lpMax').value}`);
            } else {
                params.set('tier', document.getElementById('tier').value);
                params.set('division', document.getElementById('division').value);
            }

            document.getElementById('logPanel').innerHTML = '';

            eventSource = new EventSource(`/api/scout?${params}`);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.type === 'log') {
                    addLog(data.message);
                }

                if (data.type === 'player') {
                    // Update existing player or add new one
                    const existingIndex = players.findIndex(p => p.name === data.player.name);
                    if (existingIndex >= 0) {
                        players[existingIndex] = data.player;
                    } else {
                        players.push(data.player);
                    }
                    savePlayers();
                    renderTable(existingIndex < 0);
                    updateUI();
                }

                if (data.type === 'complete') {
                    isSearching = false;
                    savePlayers();
                    updateUI();
                    eventSource.close();
                    addLog('Search complete!');
                }

                if (data.type === 'error') {
                    addLog(`Error: ${data.message}`);
                    isSearching = false;
                    updateUI();
                    eventSource.close();
                }

                if (data.type === 'ratelimit') {
                    console.log('[UI] Received ratelimit event:', data);
                    addLog(`Rate limit: ${data.isLimited ? 'WAITING ' + data.seconds + 's' : 'Resumed'}`);
                    if (data.isLimited) {
                        startRateLimitCountdown(data.seconds);
                    } else {
                        stopRateLimitCountdown();
                    }
                }
            };

            eventSource.onerror = function() {
                isSearching = false;
                updateUI();
                stopRateLimitCountdown();
                eventSource.close();
            };
        }

        let rateLimitInterval = null;

        function startRateLimitCountdown(seconds) {
            console.log('[UI] Starting rate limit countdown:', seconds, 'seconds');
            const indicator = document.getElementById('rateLimitIndicator');
            const countdown = document.getElementById('rateLimitCountdown');
            indicator.classList.add('show');
            console.log('[UI] Indicator element:', indicator, 'classList:', indicator.classList);

            let remaining = seconds;
            updateCountdownDisplay(remaining);

            if (rateLimitInterval) clearInterval(rateLimitInterval);
            rateLimitInterval = setInterval(() => {
                remaining--;
                if (remaining <= 0) {
                    stopRateLimitCountdown();
                } else {
                    updateCountdownDisplay(remaining);
                }
            }, 1000);
        }

        function stopRateLimitCountdown() {
            const indicator = document.getElementById('rateLimitIndicator');
            indicator.classList.remove('show');
            if (rateLimitInterval) {
                clearInterval(rateLimitInterval);
                rateLimitInterval = null;
            }
        }

        function updateCountdownDisplay(seconds) {
            const countdown = document.getElementById('rateLimitCountdown');
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            countdown.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function stopSearch() {
            if (eventSource) eventSource.close();
            isSearching = false;
            stopRateLimitCountdown();
            updateUI();
            addLog('Search stopped');
        }

        function updateUI() {
            const btn = document.getElementById('searchBtn');
            const btnText = document.getElementById('searchBtnText');
            const indicator = document.getElementById('statusIndicator');

            if (isSearching) {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-stop');
                btnText.textContent = 'Stop';
                indicator.style.display = 'inline-block';
                indicator.className = 'status-indicator status-searching';
            } else {
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-stop');
                btnText.textContent = 'Start Search';
                indicator.className = 'status-indicator ' + (players.length > 0 ? 'status-complete' : '');
                indicator.style.display = players.length > 0 ? 'inline-block' : 'none';
            }

            const cached = players.filter(p => p.fromCache).length;
            const fresh = players.length - cached;
            let countText = `${players.length} found`;
            if (players.length > 0 && cached > 0) {
                countText += ` (${cached} üì¶)`;
            }
            document.getElementById('playerCount').textContent = countText;
        }

        function addLog(message) {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        function toggleLog() {
            const panel = document.getElementById('logPanel');
            const icon = document.getElementById('logToggleIcon');
            panel.classList.toggle('show');
            icon.textContent = panel.classList.contains('show') ? '‚ñº' : '‚ñ∂';
        }

        function sortTable(column) {
            // Update sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update header styles
            document.querySelectorAll('.data-table th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.sort === column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });

            renderTable();
        }

        function filterPlayers() {
            renderTable();
        }

        function getFilteredSortedPlayers() {
            const filter = document.getElementById('searchFilter').value.toLowerCase();

            let filtered = players.filter(p => {
                if (!filter) return true;
                return p.name.toLowerCase().includes(filter) ||
                       p.rank.toLowerCase().includes(filter) ||
                       p.queue.toLowerCase().includes(filter) ||
                       (p.lastGameMode || '').toLowerCase().includes(filter);
            });

            // Sort
            filtered.sort((a, b) => {
                let aVal, bVal;

                switch (currentSort.column) {
                    case 'name':
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                        break;
                    case 'rank':
                        aVal = a.totalLP || 0;
                        bVal = b.totalLP || 0;
                        break;
                    case 'queue':
                        aVal = a.queue;
                        bVal = b.queue;
                        break;
                    case 'lastActiveMinutes':
                        aVal = a.lastActiveMinutes;
                        bVal = b.lastActiveMinutes;
                        break;
                    case 'lastGameMode':
                        aVal = a.lastGameMode || '';
                        bVal = b.lastGameMode || '';
                        break;
                    default:
                        return 0;
                }

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            return filtered;
        }

        function formatUpdatedAgo(timestamp) {
            if (!timestamp) return '';
            const mins = Math.floor((Date.now() - timestamp) / 60000);
            if (mins < 1) return 'just now';
            if (mins < 60) return `${mins}m ago`;
            const hours = Math.floor(mins / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        function renderTable(isNewPlayer = false) {
            const tbody = document.getElementById('tableBody');
            const emptyState = document.getElementById('emptyState');
            const filtered = getFilteredSortedPlayers();

            // Reset selection state when table is re-rendered
            selectedPuuids.clear();
            lastClickedIndex = null;
            updateDeleteButton();
            const selectAll = document.getElementById('selectAll');
            if (selectAll) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            }

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tbody.innerHTML = filtered.map((player, index) => {
                const tierClass = player.rank.split(' ')[0].toLowerCase();
                const isNewest = isNewPlayer && index === 0;
                const opggUrl = getOpggUrl(player);
                const logUrl = getLeagueOfGraphsUrl(player);
                const updatedAgo = formatUpdatedAgo(player.updatedAt);

                return `
                    <tr class="${isNewest ? 'new-row' : ''}">
                        <td class="checkbox-col"><input type="checkbox" class="player-checkbox" data-puuid="${player.puuid}" data-index="${index}" onclick="handleCheckboxClick(event, ${index})"></td>
                        <td>
                            <div class="player-name">
                                ${escapeHtml(player.name)}
                                ${player.hotStreak ? '<span class="hot-streak">üî•</span>' : ''}
                                <div class="player-actions">
                                    <button class="action-btn" onclick="copyToClipboard('${escapeHtml(player.name)}')" title="Copy name">Copy</button>
                                    <a href="${opggUrl}" target="_blank" class="action-btn opgg" title="Open OP.GG">OP.GG</a>
                                    <a href="${logUrl}" target="_blank" class="action-btn log" title="Open League of Graphs">LoG</a>
                                </div>
                            </div>
                        </td>
                        <td><span class="rank-badge rank-${tierClass}">${player.rank}</span></td>
                        <td><span class="queue-badge">${player.queue}</span></td>
                        <td class="active-badge">
                            ${player.lastActiveMinutes}m ago
                            ${player.fromCache ? '<span class="cache-badge" title="From cache">üì¶</span>' : ''}
                            <div class="updated-time" title="Last updated by script">‚Üª ${updatedAgo}</div>
                        </td>
                        <td class="game-mode-badge">${player.lastGameMode || 'CLASSIC'}</td>
                    </tr>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
        }

        // Region mapping for external sites
        const regionMap = {
            'na1': 'na',
            'euw1': 'euw',
            'eun1': 'eune',
            'kr': 'kr',
            'jp1': 'jp',
            'br1': 'br',
            'la1': 'lan',
            'la2': 'las',
            'oc1': 'oce',
            'tr1': 'tr',
            'ru': 'ru',
            'ph2': 'ph',
            'sg2': 'sg',
            'th2': 'th',
            'tw2': 'tw',
            'vn2': 'vn'
        };

        function getOpggUrl(player) {
            // OP.GG URL format: https://www.op.gg/summoners/{region}/{name}-{tag}
            const region = regionMap[player.region] || 'na';
            const [name, tag] = player.name.split('#');
            return `https://www.op.gg/summoners/${region}/${encodeURIComponent(name)}-${encodeURIComponent(tag || 'NA1')}`;
        }

        function getLeagueOfGraphsUrl(player) {
            // League of Graphs URL format: https://www.leagueofgraphs.com/summoner/{region}/{name}-{tag}
            const region = regionMap[player.region] || 'na';
            const [name, tag] = player.name.split('#');
            return `https://www.leagueofgraphs.com/summoner/${region}/${encodeURIComponent(name)}-${encodeURIComponent(tag || 'NA1')}`;
        }

        // Initial load - restores saved players from localStorage
        loadPlayers();
        // Ensure table renders even if no saved players (shows empty state)
        if (players.length === 0) renderTable();

        // Debug: expose test function for rate limit indicator
        window.testRateLimit = function(seconds = 10) {
            console.log('[DEBUG] Testing rate limit indicator for', seconds, 'seconds');
            startRateLimitCountdown(seconds);
        };
        console.log('[UI] Ready. To test rate limit indicator, run: testRateLimit(10)');
    </script>
</body>
</html>
